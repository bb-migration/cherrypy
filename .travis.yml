language: python
python:
- 2.6
- 2.7
- 3.3
- 3.4
- 3.5
- 3.6
- 3.7-dev
- pypy
- pypy3
- nightly

matrix:
  fast_finish: true
  allow_failures:
    # TODO: check what causes testing stuck
    - python: pypy
    # TODO: fix tests
    - python: pypy3
    - env: TOXENV=pre-commit-pep257
  include:
    - python: 3.6
      env: TOXENV=cheroot-master
    - python: 3.6
      env: TOXENV=pre-commit
    - python: 3.6
      env: TOXENV=pre-commit-pep257
    - python: 3.6
      env: TOXENV=dist-check

cache:
  pip: true
  directories:
    - $HOME/.pre-commit

before_install: |
  case "$TRAVIS_PYTHON_VERSION" in
    pypy) export PYPY_VERSION="pypy-2.6.1" ;;
    pypy3) export PYPY_VERSION="pypy3-2.4.0" ;;
  esac
  if ! [ -z "$PYPY_VERSION" ]
  then
    export PYENV_ROOT="$HOME/.pyenv"
    if [ -f "$PYENV_ROOT/bin/pyenv" ]
    then
      pushd "$PYENV_ROOT" && git pull && popd
    else
      rm -rf "$PYENV_ROOT" \
      && git clone --depth 1 https://github.com/yyuu/pyenv.git "$PYENV_ROOT"
    fi
    "$PYENV_ROOT/bin/pyenv" install "$PYPY_VERSION"
    virtualenv --python="$PYENV_ROOT/versions/$PYPY_VERSION/bin/python" \
               "$HOME/virtualenvs/$PYPY_VERSION"
    source "$HOME/virtualenvs/$PYPY_VERSION/bin/activate"
  fi
install: pip install tox

script: tox

after_failure: |
  if [[ "$TOXENV" != "pre-commit" ]]
  then
    echo Dumping logs, because tests failed to succeed
    for log in `ls cherrypy/test/*.log`
    do
      echo Outputting $log
      cat $log
    done
    py_log=/home/travis/build/cherrypy/cherrypy/.tox/python/log/python-0.log
    echo Outputting python invokation log from $py_log
    cat $py_log
  fi

deploy:
  provider: pypi
  on:
    tags: true
    python: 3.6
  user: ...
  password:
    secure: ...
  distributions: release
  skip_upload_docs: true
